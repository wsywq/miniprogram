<!-- pages/checkin/checkin.wxml - æ‰“å¡è¯¦æƒ…é¡µé¢æ¨¡æ¿ -->
<view class="container">
  <!-- åŠ è½½çŠ¶æ€ -->
  <view wx:if="{{loading}}" class="loading-container">
    <view class="loading"></view>
    <text class="loading-text">åŠ è½½ä¸­...</text>
  </view>

  <!-- ä¸»è¦å†…å®¹ -->
  <view wx:else>
    <!-- ä¹ æƒ¯ä¿¡æ¯å¤´éƒ¨ -->
    <view class="habit-header">
      <view class="habit-info">
        <view class="habit-icon">{{habit.icon}}</view>
        <view class="habit-details">
          <text class="habit-name">{{habit.name}}</text>
          <text class="habit-category">{{habit.category}}</text>
        </view>
      </view>
      <view class="habit-actions">
        <view class="action-btn" bindtap="goToEdit">
          <text class="action-icon">âœï¸</text>
        </view>
      </view>
    </view>

    <!-- ç»Ÿè®¡å¡ç‰‡ -->
    <view class="stats-section">
      <view class="stat-card">
        <text class="stat-number">{{streakDays}}</text>
        <text class="stat-label">è¿ç»­å¤©æ•°</text>
      </view>
      <view class="stat-card">
        <text class="stat-number">{{completionRate}}%</text>
        <text class="stat-label">æœ¬æœˆå®Œæˆç‡</text>
      </view>
      <view class="stat-card">
        <text class="stat-number">{{Object.keys(checkins).length}}</text>
        <text class="stat-label">æœ¬æœˆæ‰“å¡</text>
      </view>
    </view>

    <!-- ä»Šæ—¥æ‰“å¡çŠ¶æ€ -->
    <view class="today-section card">
      <view class="section-header">
        <text class="section-title">ä»Šæ—¥æ‰“å¡</text>
        <text class="today-date">{{currentMonth}}-{{new Date().getDate()}}</text>
      </view>
      
      <view wx:if="{{todayCheckin}}" class="checkin-completed">
        <view class="completed-icon">âœ…</view>
        <view class="completed-info">
          <text class="completed-text">ä»Šæ—¥å·²å®Œæˆæ‰“å¡</text>
          <text class="completed-time">{{todayCheckin.checkin_time}}</text>
          <text wx:if="{{todayCheckin.note}}" class="completed-note">{{todayCheckin.note}}</text>
        </view>
      </view>
      
      <view wx:else class="checkin-pending">
        <view class="pending-icon">â°</view>
        <view class="pending-info">
          <text class="pending-text">ä»Šæ—¥è¿˜æœªæ‰“å¡</text>
          <text class="pending-desc">åšæŒå°±æ˜¯èƒœåˆ©ï¼</text>
        </view>
        <button class="btn btn-primary" bindtap="showCheckinModal">
          ç«‹å³æ‰“å¡
        </button>
      </view>
    </view>

    <!-- æ—¥å†è§†å›¾ -->
    <view class="calendar-section card">
      <view class="section-header">
        <text class="section-title">æœ¬æœˆè®°å½•</text>
        <text class="month-text">{{currentMonth}}</text>
      </view>
      
      <view class="calendar">
        <!-- æ˜ŸæœŸæ ‡é¢˜ -->
        <view class="week-header">
          <text class="week-day">æ—¥</text>
          <text class="week-day">ä¸€</text>
          <text class="week-day">äºŒ</text>
          <text class="week-day">ä¸‰</text>
          <text class="week-day">å››</text>
          <text class="week-day">äº”</text>
          <text class="week-day">å…­</text>
        </view>
        
        <!-- æ—¥æœŸç½‘æ ¼ -->
        <view class="calendar-grid">
          <view wx:for="{{calendar}}" wx:key="index" class="calendar-week">
            <view 
              wx:for="{{item}}" 
              wx:for-item="date" 
              wx:key="index"
              class="calendar-day {{date ? (date.hasCheckin ? 'has-checkin' : (date.isToday ? 'today' : '')) : 'empty'}}"
              data-date="{{date}}"
              bindtap="onDateTap"
              bindlongpress="makeupCheckin"
            >
              <text wx:if="{{date}}" class="day-number">{{date.date}}</text>
              <view wx:if="{{date && date.hasCheckin}}" class="checkin-dot"></view>
            </view>
          </view>
        </view>
      </view>
      
      <view class="calendar-legend">
        <view class="legend-item">
          <view class="legend-dot completed"></view>
          <text class="legend-text">å·²æ‰“å¡</text>
        </view>
        <view class="legend-item">
          <view class="legend-dot today"></view>
          <text class="legend-text">ä»Šå¤©</text>
        </view>
        <view class="legend-item">
          <text class="legend-text">é•¿æŒ‰å¯è¡¥å¡</text>
        </view>
      </view>
    </view>
  </view>

  <!-- æ‰“å¡å¼¹çª— -->
  <view wx:if="{{showCheckinModal}}" class="modal-overlay" bindtap="hideCheckinModal">
    <view class="checkin-modal" catchtap="true">
      <view class="modal-header">
        <text class="modal-title">ä»Šæ—¥æ‰“å¡</text>
        <view class="modal-close" bindtap="hideCheckinModal">Ã—</view>
      </view>
      
      <view class="modal-content">
        <!-- å¤‡æ³¨è¾“å…¥ -->
        <view class="form-item">
          <view class="form-label">æ‰“å¡å¤‡æ³¨ï¼ˆå¯é€‰ï¼‰</view>
          <textarea 
            class="form-textarea"
            placeholder="è®°å½•ä¸€ä¸‹ä»Šå¤©çš„æ„Ÿå—æˆ–æ”¶è·..."
            value="{{checkinForm.note}}"
            maxlength="100"
            bindinput="onNoteInput"
          />
        </view>
        
        <!-- å›¾ç‰‡ä¸Šä¼  -->
        <view class="form-item">
          <view class="form-label">æ·»åŠ å›¾ç‰‡ï¼ˆå¯é€‰ï¼‰</view>
          <view wx:if="{{checkinForm.image}}" class="image-preview">
            <image src="{{checkinForm.image}}" mode="aspectFill" class="preview-image"/>
            <view class="image-remove" bindtap="removeImage">Ã—</view>
          </view>
          <view wx:else class="image-upload" bindtap="chooseImage">
            <text class="upload-icon">ğŸ“·</text>
            <text class="upload-text">æ·»åŠ å›¾ç‰‡</text>
          </view>
        </view>
      </view>
      
      <view class="modal-actions">
        <button class="btn btn-outline" bindtap="hideCheckinModal">å–æ¶ˆ</button>
        <button class="btn btn-primary" bindtap="confirmCheckin">ç¡®è®¤æ‰“å¡</button>
      </view>
    </view>
  </view>
</view>
